# yii2-permissions

Управление пользовательскими разрешениями для Yii2

![GitHub Workflow Status](https://img.shields.io/github/workflow/status/cusodede/yii2-permissions/CI%20with%20PostgreSQL)

# Мысли по ходу дела

* В БД - конфигурируемые данные, в конфигах - статические.
* Можно подключать статику полномочий из любых конфигов. Коллекции подключать нельзя.
* Опционально, можно перегонять конфиги в БД.
* Не нужно писать в каждом контроллере правила

# Идея подхода, формальная модель, отличия от RBAC

Базовая идея в том, чтобы раз и навсегда переложить управление доступами с плеч разработчика на менеджера. Разработчик не должен создавать
доступы, описывать их, и он должен быть избавлен от необходимости доступы назначать. Менеджер же, с одной стороны, должен обладать полным
набором удобного инструментария, помогающего ему ориентироваться в управлении, с другой - не иметь возможности сделать ничего «лишнего».

Из этого родились следующие принципы:

* **Полномочия атомарны.** Одно полномочие - одно явное **разрешение**.
* **Запрещено всё, что не разрешено.** Полномочия всегда только разрешают, и никогда не запрещают доступ.
* **Полномочия группируются.** Из **разрешений** можно собрать **коллекцию разрешений**, суммирующую все вошедшие в неё доступы.
* **Коллекции разрешений могут включать другие коллекции**. **Коллекция**, включающая в себя другие **коллекции**, обладает множеством
  всех **разрешений** из этих **коллекций**.
* **Субъекту можно назначать и коллекции и разрешения.** В этом случае субъект будет обладать множеством всех **разрешений** из
  назначенных **коллекций** и из непосредственных **разрешений**.
* **Полномочия, коллекции и назначения - данные, а не код.** Данными может управлять внешний пользователь, кодом может управлять только
  разработчик.

В отличии от классической RBAC-модели, решение опирается на сущность **полномочия**, а не на сущность **роли**: в RBAC проверяется, какие
у пользователя **роли**, и уже из ролей агрегируются доступы, в yii2-permissions полномочия агрегируются сразу.

|                                   | yii2-permissions                                             | RBAC (реализация yii/rbac)                    |
|-----------------------------------|--------------------------------------------------------------|-----------------------------------------------|
| Базовая сущность                  | Полномочие (атомарное право доступа).                        | Роль (совокупность прав доступа).             |
| Субъект полномочия                | Человек или автоматизированный агент.                        | Человек или автоматизированный агент.         |
| Объединение полномочий            | Коллекция: совокупность полномочий и коллекций (рекурсивно). | Совокупность полномочий.                      |
| Назначение полномочий субъекту    | Коллекции и полномочия в любых комбинациях.                  | Только роли.                                  |
| Прямое назначение полномочий      | Разрешено.                                                   | Запрещено.                                    |
| Действие полномочия               | Разрешающее (всё, что не разрешено, то запрещено).           | Ситуативное (определяется в момент проверки). |
| Конфликты полномочий              | Отсутствуют принципиально.                                   | Решаются нормативными ограничениями.          |
| Отношения доступов                | Иерархические.                                               | Иерархические.                                |
| Хранение доступов                 | БД                                                           | БД и/или код.                                 |
| Предсоздание доступов             | Через код (конфигурации).                                    | Через код (конфигурации/миграции).            |
| Доступы по умолчанию              | Есть.                                                        | Есть.                                         |
| Интерфейс управления              | Админка в приложении, может быть доступна пользователям.     | Нет.                                          |

# Установка и настройка

Выполните

```
php composer.phar require cusodede/yii2-permissions "^1.0.0"
```

или добавьте

```
"cusodede/yii2-permissions": "^1.0.0"
```

в секцию `require`, после чего выполните `composer update`

## Миграции

Модуль хранит данные в таблицах, которые будут созданы командой

```
php yii migrate/up --migrationPath=@vendor/cusodede/yii2-permissions/migrations
```

список названий таблиц, создаваемых миграцией, можно посмотреть в файле `migrations/m000000_000000_sys_permissions.php`. Само собой, эту
миграцию нужно выполнять только для новых проектов, для текущих, если эти таблицы были созданы ранее, миграцию применять не нужно.

## Настройка

Подключите модуль в секцию `modules` вашего конфигурационного файла. Все настройки модуля описываются в секции `params`. Пример
конфигурации:

```php
return [
    // ...
    'modules' => [
        'permissions' => [
            'class' => cusodede\permissions\PermissionsModule::class,
            'params' => [
                'controllerDirs' => [
                   '@app/controllers' => null,
                   '@app/modules/api/controllers' => 'api',
                   '@vendor/cusodede/yii2-permissions/src/controllers' => '@permissions',
                ],
                'grant' => [
                    2 => ['login_as_another_user', 'some_other_permission']
                ],
                'grantAll' => [1],
                'importDirs' => [
                    '@app/permissions/'
                ],
                'permissions' => [ 
                    'system' => [
                         'comment' => 'Разрешение на доступ к системным параметрам',
                    ],
                    'login_as_another_user' => [
                         'comment' => 'Разрешение авторизоваться под другим пользователем',
                    ],
                    'site:error:post' => [
                        'controller' => 'site',
                        'action' => 'error',
                        'verb' => 'post',
                        'comment' => 'Разрешение POST для actionError в SiteController'
                    ]
                ]
                'userCurrentIdentity' => Yii::$app->user->identity,
                'userIdentityClass' => Yii::$app->user->identityClass,
                'viewPath' => [
                    'permissions' => '@vendor/cusodede/yii2-permissions/src/views/permissions',
                    'permissions-collections' => '@vendor/cusodede/yii2-permissions/src/views/permissions-collections'
                ],
            ]
        ] 
    ]
    // ...
]
```

Описание параметров:

* `controllerDirs`: список путей к каталогам контроллеров, которые а) должны появиться в панели управления модуля; б) будут обслуживаться
  генератором `permissions/default/init-controllers-permissions` по умолчанию. Настройка не влияет непосредственно на работу доступов, она
  отвечает только за удобство их настройки. Формат `'path\to\controllers\dir' => 'module id'`,
  например `'@app/modules/api/controllers' => 'api'`. При этом:
    * Для контроллеров основного приложения модуль можно не указывать: `'@app/controllers' => null`. Однако, если необходимо, можно указать
      id самого приложения.
    * Если необходимо избежать загрузки модуля при инициализации его контроллеров (это делается для получения списка действий внутри
      контроллера), укажите id модуля через `@`: `'@app/modules/api/controllers' => '@api'`.
* `grant`: перечисление прямых назначений привилегий в формате `user_id => [список получаемых привилегий]`. Назначения из этого списка
  «суммируются» с назначениями, сделанными через пользовательский интерфейс, но не редактируются из него.
* `grantAll`: перечисление идентификаторов пользователей, получающих все доступы. Укажите здесь идентификаторы пользователей, проводящих
  настройку приложения, затем, при желании, полный доступ им можно отключить.
* `importDirs`: список путей к каталогам, содержащим конфигурации импортируемых привилегий для
  генератора [import-permissions](import-permissions).
* `'permissions'`: список преднастроенных привилегий, доступных сразу, без конфигурирования в приложении. Эти привилегии, в т.ч., могут быть
  назначены через параметр `grant`. Также этит привилегии могут быть перенесены в БД
  генератором [init-config-permissions](init-config-permissions).
* `'userCurrentIdentity'`: экземпляр класса, идентифицирующий сущность текущего пользователя (если отличается
  от `Yii::$app->user->identity`). Может быть указано замыканием.
* `'userIdentityClass'`: имя класса, определяющего identity пользователя. Может быть указано замыканием. Имеет низший приоритет к
  параметру `'userCurrentIdentity'`.
* `viewPath`: пути к каталогам с кастомными шаблонам модуля, если нужно, например, привести их в соответствие с дизайном вашего приложения.
  Поддерживаются `permissions` (шаблоны страниц управления доступами) и `permissions-collections` (шаблоны страниц управления коллекциями).
  Если не задано, используются соответствующие шаблоны из `@vendor/cusodede/yii2-permissions/src/views/`.

# Какие задачи решаются и каким образом?

## Управление полномочиями

В модуле предусмотрен интерфейс управления, которым можно пользоваться сразу после установки:

- `permissions/permissions` предоставляет таблицу управления атомарными доступами: здесь можно создать или отредактировать доступ, и
  увидеть, каким пользователям он присвоен.
- `permissions/permissions-collections` позволяет группировать доступы в коллекции,
- `permissions/default` открывает доступ к [Генераторы полномочий](генераторам полномочий).

## Контроль доступов к Controller/Action/Verb

Поскольку наиболее часто решаемая через доступы задача - контроль разрешений адресов приложения, этот функционал встроен
непосредственно в модуль. Каждое полномочие может быть прямо в админке привязано к контроллеру, к действию контроллера (опционально) и
(также опционально) к методу запроса к действию, после чего им можно пользоваться для включения доступа к указанному адресу.

Чтобы контроль доступов начал работать, в соответствующем контроллере нужно подключить
фильтр `cusodede\permissions\filters\PermissionFilter::class`:

```php
/**
 * @inheritDoc
 */
public function behaviors():array {
    return [
        'access' => [
            'class' => cusodede\permissions\filters\PermissionFilter::class
        ]
    ];
}
```

## Генераторы полномочий

### **import-permissions**

### **init-controllers-permissions**

Чтобы не создавать вручную доступы к каждому контроллеру, проще всего воспользоваться генератором полномочий. Он может быть вызван в админке
по адресу `permissions/default/init-controllers-permissions` или выполнением консольной
команды `yii permissions/init-controllers-permissions`.

Этот генератор создаст полномочия доступа для каждого действия каждого контроллера приложения (в т.ч., для контроллеров модулей), и
объединит эти полномочия в коллекции, по одной коллекции на контроллер.

### **init-config-permissions**

Несмотря на то, что управление доступами вынесено на сторону приложения, остаётся и возможность добавления доступов через конфигурацию
модуля (описание формата см. в разделе [Конфигурация модуля](Конфигурация модуля)). Запуск генератора **init-config-permissions** создаст в
БД
набор правил из такой конфигурации, вызвать его можно, обратившись на адрес `permissions/default/init-config-permissions` или выполнив
консольную команду `yii permissions/init-config-permissions`

## Прямой контроль доступов

## Контроль области видимости запросов

## Проверка доступности адресов

# Краткий обзор методов модуля

## `cusodede\permissions\traits\UsersPermissionsTrait`: методы проверки доступов пользователя.

Трейт должен быть подключён в классе пользователя.

* `UsersPermissionsTrait::hasPermission()`: проверяет, имеет ли пользователь право или набор прав с указанной логикой
  проверки.
* `UsersPermissionsTrait::allPermissions()`: возвращает все доступы пользователя с сортировкой по приоритету.
* `UsersPermissionsTrait::grantPermission()`: добавляет пользователю доступ по имени или идентификатору, или напрямую.
* `UsersPermissionsTrait::revokePermission()`: отзывает у пользователя доступ по имени или идентификатору, или напрямую.
* `UsersPermissionsTrait::grantCollection()`: добавляет пользователю коллекцию доступов по имени или идентификатору, или
  напрямую.
* `UsersPermissionsTrait::revokeCollection()`: отзывает у пользователя коллекцию доступов по имени или идентификатору,
  или напрямую.
* `UsersPermissionsTrait::hasActionPermission()`
* `UsersPermissionsTrait::hasControllerPermission()`
* `UsersPermissionsTrait::hasUrlPermission()`

# Установка

# Конфигурация модуля

Вот вам пример конфига по умолчанию с описаниями параметров:

# Команды модуля

TBD

# Использование (модели, трейты, etc)

TBD

# Запуск локальных тестов

Скопируйте `tests/.env.example` в `tests/.env`, и измените конфигурацию соответственно вашему локальному окружению.
Затем выполните
команду `php vendor/bin/codecept run`.
